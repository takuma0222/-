# 要件定義書

## 1. システム概要

### 1.1 システム名
**部材照合システム（Balance Inspection System）**

### 1.2 目的
製造現場における部材照合作業の効率化と正確性向上を目的とし、天秤を用いた部材の枚数照合をシステム化する。異常終了時のセッション復元機能により、作業の中断・再開を可能にする。

### 1.3 適用範囲
- 製造現場での部材照合作業
- 棚入庫・棚出庫管理
- 照合結果のログ記録

---

## 2. 機能要件

### 2.1 認証機能（FR-001）

#### FR-001-01: 従業員認証
- **要件**: 従業員Noを入力し、従業員マスタから氏名を取得・表示する
- **入力**: 従業員No（6桁）
- **処理**:
  - TCP/IPソケット通信またはCSVファイルから従業員情報を取得
  - 該当する従業員名を表示
  - 該当なしの場合は「ユーザなし」と表示
- **出力**: 従業員名、または「ユーザなし」
- **制約**:
  - 従業員No入力後は非活性化
  - 認証成功後、カードNo入力欄を活性化

---

### 2.2 カード情報取得機能（FR-002）

#### FR-002-01: カード情報取得
- **要件**: カードNoを入力し、カード条件と使用部材条件を取得する
- **入力**: 
  - カードNo（6桁）
  - LAP厚（コンボボックスで選択: 250μm, 150μm, 100μm, 75μm, 50μm）
- **処理**:
  - TCP/IPソケット通信またはCSVファイルからカード条件を取得
  - LAP厚に基づいて使用部材条件を取得
  - 該当する条件を画面に表示
- **出力**:
  - カード情報（カードNo、品名、ロットNo、枚数、工程）
  - 必要枚数（投入前10mm、投入後1mm/5mm/10mm、エッジガード、気泡緩衝材）
- **制約**:
  - カードNo入力後は非活性化
  - 条件なしの場合は「条件なし」と表示し、照合ボタンを非活性

---

### 2.3 部材照合機能（FR-003）

#### FR-003-01: 第1段階照合（投入前10mm照合）
- **要件**: 投入前10mm部材の枚数を照合する
- **入力**: 
  - 必要枚数（システムが自動取得）
  - 天秤からの重量データ
- **処理**:
  - 天秤から重量を取得（シリアル通信 9600bps）
  - 重量を枚数に変換（1枚あたりの重量: 1.15g）
  - 照合前数と照合後数を比較
  - 過不足を計算
- **出力**:
  - 照合前数、照合後数、過不足数、判定（OK/不足/過剰）
  - OK時: 緑色メッセージ「照合OK。投入前10mmをプロトスに入れて移載してください\n移載後、投入後1mm/5mm/10mmの必要枚数を用意して再照合してください」
  - NG時: 赤色メッセージ「不足/過剰: 投入前10mm 必要X個 使用Y個 不足Z個」
- **制約**:
  - OK時のみ第2段階に進む
  - OK時にセッション状態を保存

#### FR-003-02: 第2段階照合（投入後部材照合）
- **要件**: 投入後1mm/5mm/10mm、エッジガード、気泡緩衝材の枚数を照合する
- **入力**: 
  - 各部材の必要枚数（システムが自動取得）
  - 天秤からの重量データ
- **処理**:
  - 天秤から各部材の重量を取得
  - 重量を枚数に変換（各部材ごとに異なる重量）
  - 照合前数と照合後数を比較
  - 各部材の過不足を計算
- **出力**:
  - 各部材の照合前数、照合後数、過不足数、判定
  - 全てOK時: 緑色メッセージ「照合OK」
  - NG時: 赤色メッセージ「不足/過剰: 部材名 必要X個 使用Y個 不足Z個」
- **制約**:
  - 全ての部材がOKの場合のみ照合完了
  - 完了時にログを記録し、セッション状態を削除

---

### 2.4 棚管理機能（FR-004）

#### FR-004-01: 棚入庫
- **要件**: 照合完了後に棚への入庫情報を記録する
- **入力**: 
  - カードNo、品名、ロットNo、枚数、工程
  - 入庫先棚番号
  - 入庫日時
- **処理**:
  - 入庫情報をCSVファイルに追記
  - 入庫完了メッセージを表示
- **出力**: 入庫完了メッセージ
- **制約**: 照合完了後のみ実行可能

#### FR-004-02: 棚出庫
- **要件**: 棚からの出庫情報を検索・記録する
- **入力**: 
  - 検索条件（カードNo、品名、ロットNo、工程のいずれか）
  - 出庫枚数
  - 出庫日時
- **処理**:
  - 入庫情報から検索条件に一致するデータを取得
  - 選択された入庫情報に対して出庫情報を記録
  - 出庫情報をCSVファイルに追記
- **出力**: 出庫完了メッセージ
- **制約**: 
  - 出庫枚数は入庫枚数以下
  - 既に出庫済みのデータは再出庫不可

---

### 2.5 ログ記録機能（FR-005）

#### FR-005-01: 照合結果ログ
- **要件**: 照合完了時に結果を記録する
- **入力**: 
  - 従業員No
  - カードNo
  - カード条件情報
  - 照合結果（OK/NG）
- **処理**:
  - 日付ごとにログファイルを作成（YYYYMMDD.csv）
  - ログ情報をCSV形式で追記
- **出力**: ログファイル（logs/YYYYMMDD.csv）
- **制約**: 照合結果のみを記録（操作履歴は記録しない）

#### FR-005-02: エラーログ
- **要件**: エラー発生時にエラー情報を記録する
- **入力**: 
  - エラー発生日時
  - エラーメッセージ
  - エラー詳細
- **処理**:
  - エラーログファイルに追記（logs/error/YYYYMMDD_error.log）
- **出力**: エラーログファイル
- **制約**: すべてのエラーを記録

---

### 2.6 セッション管理機能（FR-006）

#### FR-006-01: セッション状態保存
- **要件**: 第1段階照合完了時に作業状態を保存する
- **入力**: 
  - 従業員No、従業員名
  - カードNo
  - LAP厚
  - 投入前10mmの照合結果（照合前数、照合後数、過不足数、判定）
  - カード条件、使用部材条件（JSON形式）
- **処理**:
  - セッション状態をJSON形式でファイルに保存（session_state.json）
  - タイムスタンプを記録
- **出力**: session_state.jsonファイル
- **制約**: 第1段階完了時のみ保存

#### FR-006-02: セッション状態復元
- **要件**: アプリ起動時に未完了セッションを検出し、復元確認を行う
- **入力**: session_state.jsonファイル
- **処理**:
  - 起動時にセッションファイルの存在を確認
  - 存在する場合、復元確認ダイアログを表示
  - ユーザーが「はい」を選択した場合、セッション状態を復元
    - 従業員情報、カード情報、LAP厚を復元
    - 投入前10mmの照合結果を復元
    - 投入後部材の最新値を天秤から取得
    - 第1段階完了時と同じメッセージを表示
    - カードNo入力欄を非活性化
  - ユーザーが「いいえ」を選択した場合、セッションファイルを削除
- **出力**: 復元された画面状態、またはセッションファイル削除
- **制約**: 
  - 第1段階完了状態（Stage=1）のみ復元対象
  - 復元時に従業員NoのTextChangedイベントを抑制

#### FR-006-03: セッション状態削除
- **要件**: 照合完了時またはキャンセル時にセッション状態を削除する
- **入力**: なし
- **処理**:
  - session_state.jsonファイルを削除
- **出力**: なし
- **制約**: 
  - 第2段階照合完了時に自動削除
  - キャンセルボタン押下時に削除
  - アプリ終了時に削除（確認ダイアログ後）

---

## 3. 非機能要件

### 3.1 性能要件（NFR-001）

#### NFR-001-01: 応答時間
- 天秤からのデータ取得: 5秒以内
- カード条件取得: 3秒以内
- 画面表示更新: 1秒以内

#### NFR-001-02: 同時接続数
- シリアルポート: 1接続（天秤）
- TCPソケット: 最大2接続（従業員情報、カード情報）

---

### 3.2 可用性要件（NFR-002）

#### NFR-002-01: システム稼働率
- 稼働時間: 製造時間帯（8:00～20:00）
- 目標稼働率: 99%以上

#### NFR-002-02: 障害復旧
- 異常終了時のセッション復元機能により、作業の継続性を確保
- セッション状態ファイルの破損時は自動削除し、通常起動

---

### 3.3 操作性要件（NFR-003）

#### NFR-003-01: ユーザビリティ
- メッセージ表示: 最大2行、高さ140px、フォントサイズ13pt
- カラーコーディング:
  - 成功: 緑色
  - エラー: 赤色
  - 情報: 黒色
- ボタン配置: 統一されたグレー色（RGB: 128, 128, 128）

#### NFR-003-02: キーボード操作
- Tab/Enterキーでの画面遷移
- 従業員No → カードNo → LAP厚 → 照合ボタンの順に操作可能

#### NFR-003-03: 確認ダイアログ
- キャンセルボタン押下時: 「入力内容をクリアしますか？」
- アプリ終了時: 「アプリケーションを終了しますか？」
- セッション復元時: 「前回の照合作業が途中で終了しています。前回の状態から再開しますか？」

---

### 3.4 保守性要件（NFR-004）

#### NFR-004-01: ログ管理
- 日次ログファイルを自動生成
- ログファイル形式: CSV
- ログ保存期間: 無期限（手動削除）

#### NFR-004-02: 設定ファイル
- アプリケーション設定: App.config（XML形式）
- カード条件: card_conditions.csv
- 使用部材条件: material_conditions.csv
- 従業員情報: employees.csv（ソケット通信が優先）

---

### 3.5 セキュリティ要件（NFR-005）

#### NFR-005-01: アクセス制御
- 従業員認証による操作者の記録
- ログファイルへの操作者情報の記録

#### NFR-005-02: データ保護
- セッション状態ファイルの暗号化: なし（ローカル環境のみで使用）
- ログファイルの改ざん防止: なし（CSV形式での記録）

---

### 3.6 互換性要件（NFR-006）

#### NFR-006-01: OS互換性
- 対象OS: Windows 10/11
- .NET Framework: 4.7.1以上

#### NFR-006-02: ハードウェア互換性
- 天秤: シリアル通信対応（9600bps、8bit、パリティなし、ストップビット1）
- ネットワーク: TCP/IP対応

---

## 4. 制約条件

### 4.1 技術的制約
- 開発言語: VB.NET
- フレームワーク: Windows Forms
- 通信プロトコル: 
  - シリアル通信（RS-232C）
  - TCP/IPソケット通信
- データ形式: CSV、JSON

### 4.2 運用制約
- シングルユーザー運用（同時に1名のみ使用）
- ローカル環境での実行（ネットワークドライブ不可）
- 天秤との接続は起動時に確立

### 4.3 データ制約
- 従業員No: 6桁固定
- カードNo: 6桁固定
- ログファイルサイズ: 無制限
- セッションファイル: 1ファイルのみ（複数セッション非対応）

---

## 5. システム構成要件

### 5.1 ハードウェア要件
- CPU: Intel Core i3以上
- メモリ: 4GB以上
- ストレージ: 10GB以上の空き容量
- シリアルポート: COM1～COM20のいずれか
- ネットワーク: 有線LAN（任意、ソケット通信使用時）

### 5.2 ソフトウェア要件
- OS: Windows 10/11（64bit）
- .NET Framework: 4.7.1以上
- 天秤制御ドライバ: 標準シリアルポートドライバ

### 5.3 ネットワーク要件（任意）
- TCP/IPソケット通信（従業員情報、カード情報取得時）
- IPアドレス: 192.168.1.100（例）
- ポート番号: 
  - 従業員情報: 5001
  - カード情報: 5002

---

## 6. データ要件

### 6.1 カード条件マスタ（card_conditions.csv）
| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| CardNo | String(6) | ○ | カード番号 |
| ProductName | String | ○ | 品名 |
| LotNo | String | ○ | ロット番号 |
| Quantity | Integer | ○ | 枚数 |
| Location | String | ○ | 工程 |
| EdgeGuard | Integer | ○ | エッジガード必要枚数（0=不要） |
| BubbleInterference | Integer | ○ | 気泡緩衝材必要枚数（0=不要） |

### 6.2 使用部材条件マスタ（material_conditions.csv）
| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| CardNo | String(6) | ○ | カード番号 |
| LapThickness | String | ○ | LAP厚（250μm等） |
| Pre10mm | Integer | ○ | 投入前10mm必要枚数 |
| Post1mm | Integer | ○ | 投入後1mm必要枚数 |
| Post5mm | Integer | ○ | 投入後5mm必要枚数 |
| Post10mm | Integer | ○ | 投入後10mm必要枚数 |

### 6.3 従業員マスタ（employees.csv）
| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| EmployeeNo | String(6) | ○ | 従業員番号 |
| EmployeeName | String | ○ | 従業員名 |

### 6.4 セッション状態ファイル（session_state.json）
```json
{
  "Timestamp": "2025-11-10T22:00:00",
  "Stage": 1,
  "EmployeeNo": "123456",
  "EmployeeName": "山田太郎",
  "CardNo": "E00123",
  "LapThickness": "250μm",
  "Pre10mmBefore": 2,
  "Pre10mmAfter": 1,
  "Pre10mmShortage": 0,
  "Pre10mmJudgment": "OK",
  "CardConditionJson": "{...}",
  "MaterialConditionJson": "{...}"
}
```

### 6.5 照合ログファイル（logs/YYYYMMDD.csv）
| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| Timestamp | DateTime | ○ | 照合日時 |
| EmployeeNo | String(6) | ○ | 従業員番号 |
| CardNo | String(6) | ○ | カード番号 |
| ProductName | String | ○ | 品名 |
| LotNo | String | ○ | ロット番号 |
| Result | String | ○ | 照合結果（OK/NG） |

### 6.6 棚入庫ファイル（shelf_storage.csv）
| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| StorageId | String | ○ | 入庫ID（GUID） |
| CardNo | String(6) | ○ | カード番号 |
| ProductName | String | ○ | 品名 |
| LotNo | String | ○ | ロット番号 |
| Quantity | Integer | ○ | 枚数 |
| Location | String | ○ | 工程 |
| ShelfNumber | String | ○ | 棚番号 |
| StorageDate | DateTime | ○ | 入庫日時 |
| IsRetrieved | Boolean | ○ | 出庫済みフラグ |

---

## 7. 画面要件

### 7.1 メイン画面（MainForm）
- **目的**: 部材照合作業のメイン画面
- **構成要素**:
  - 従業員情報入力エリア
  - カード情報入力エリア
  - カード情報表示エリア
  - 使用部材条件表示エリア（テーブル形式）
  - メッセージ表示エリア（2行、140px高）
  - 照合ボタン、キャンセルボタン
  - 棚入庫ボタン、棚出庫ボタン

### 7.2 棚入庫画面（ShelfStorageForm）
- **目的**: 照合完了後の棚入庫情報登録
- **構成要素**:
  - カード情報表示（読取専用）
  - 棚番号入力欄
  - 入庫日時表示
  - 入庫ボタン、キャンセルボタン

### 7.3 棚出庫画面（ShelfRetrievalForm）
- **目的**: 棚からの出庫情報検索・登録
- **構成要素**:
  - 検索条件入力エリア
  - 検索結果表示テーブル
  - 出庫枚数入力欄
  - 出庫ボタン、キャンセルボタン

---

## 8. インターフェース要件

### 8.1 外部システム連携

#### 8.1.1 天秤インターフェース
- **通信方式**: シリアル通信（RS-232C）
- **通信設定**: 9600bps、8bit、パリティなし、ストップビット1
- **データ形式**: ASCII文字列
- **コマンド**: 
  - 重量取得: "S\r\n"
  - ゼロリセット: "Z\r\n"
- **レスポンス**: "+0000.00 g\r\n" 形式

#### 8.1.2 従業員情報システム連携（任意）
- **通信方式**: TCP/IPソケット通信
- **IPアドレス**: 設定ファイルで指定
- **ポート番号**: 5001（デフォルト）
- **プロトコル**: 
  - リクエスト: 従業員No（6桁）
  - レスポンス: 従業員名（UTF-8文字列）

#### 8.1.3 カード情報システム連携（任意）
- **通信方式**: TCP/IPソケット通信
- **IPアドレス**: 設定ファイルで指定
- **ポート番号**: 5002（デフォルト）
- **プロトコル**: 
  - リクエスト: カードNo（6桁）
  - レスポンス: カード情報（JSON形式）

---

## 9. テスト要件

### 9.1 機能テスト
- 従業員認証の正常/異常系テスト
- カード情報取得の正常/異常系テスト
- 第1段階照合の正常/異常系テスト（OK/不足/過剰）
- 第2段階照合の正常/異常系テスト
- セッション保存・復元のテスト
- 棚入庫・出庫のテスト

### 9.2 非機能テスト
- 性能テスト（応答時間測定）
- 負荷テスト（連続照合処理）
- 異常系テスト（通信エラー、ファイル破損等）

### 9.3 運用テスト
- 実機での照合作業テスト
- セッション復元の実運用テスト
- ログ記録の確認テスト

---

## 10. 移行要件

### 10.1 データ移行
- 既存の従業員マスタデータのCSV変換
- 既存のカード条件データのCSV変換

### 10.2 環境移行
- 天秤との接続設定
- シリアルポート番号の確認・設定
- ネットワーク設定（ソケット通信使用時）

---

## 11. 運用要件

### 11.1 日次運用
- ログファイルのバックアップ（任意）
- エラーログの確認

### 11.2 定期運用
- マスタデータの更新（カード条件、使用部材条件、従業員情報）
- セッション状態ファイルの手動削除（必要に応じて）

### 11.3 障害対応
- 天秤接続エラー時の対応手順
- セッションファイル破損時の復旧手順
- ログファイル肥大化時の対応手順

---

## 12. 制限事項

### 12.1 機能制限
- 複数ユーザーの同時使用不可
- セッション状態は1つのみ保持（複数セッション非対応）
- 過去のセッション履歴は保持しない

### 12.2 性能制限
- 天秤からのデータ取得は同期処理（非同期非対応）
- 大量データの一括処理非対応

### 12.3 互換性制限
- Windows専用（macOS、Linux非対応）
- .NET Framework 4.7.1以上必須

---

## 改訂履歴

| 版数 | 改訂日 | 改訂者 | 改訂内容 |
|------|--------|--------|----------|
| 1.0 | 2025-11-10 | システム開発チーム | 初版作成 |

