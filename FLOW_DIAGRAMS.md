# アプリケーションフロー図

## 画面遷移図

```
[起動]
  ↓
┌─────────────────────────────────────────────────────┐
│ メイン画面（初期状態）                                     │
│                                                     │
│ 従業員No: [______]  カードNo: [______]                │
│                                                     │
│ メッセージ: 従業員Noを入力してください                      │
│                                                     │
│ [照合]（無効）  [キャンセル]                             │
│                                                     │
│ ┌───────────────────────────────────────┐           │
│ │ 使用部材条件テーブル（空）                │           │
│ └───────────────────────────────────────┘           │
└─────────────────────────────────────────────────────┘
  ↓ 従業員No入力（6桁）
  ↓ カードNo入力（6桁）
  ↓ フォーカスアウト
  ↓
┌─────────────────────────────────────────────────────┐
│ メイン画面（条件表示）                                     │
│                                                     │
│ 従業員No: [123456]  カードNo: [e00123]               │
│                                                     │
│ メッセージ: 使用部材条件を表示しました（緑）                 │
│                                                     │
│ [照合]（有効）  [キャンセル]                             │
│                                                     │
│ ┌───────────────────────────────────────┐           │
│ │ 1mm | 5mm | 10mm | ガード | 気泡  │           │
│ │  2  |  0  |  1   |   1    |  05  │           │
│ └───────────────────────────────────────┘           │
│                                                     │
│ ※バックグラウンドで初回計測完了                            │
└─────────────────────────────────────────────────────┘
  ↓ [照合]クリック
  ↓ 照合時計測実行
  ↓ 差分計算・判定
  ↓
┌─────────────────────────────────────────────────────┐
│ メイン画面（合格）                                        │
│                                                     │
│ 従業員No: [123456]  カードNo: [e00123]               │
│                                                     │
│ メッセージ: 検査合格（緑）                                │
│                                                     │
│ [照合]（無効）  [キャンセル]                             │
│                                                     │
│ ┌───────────────────────────────────────┐           │
│ │ 1mm | 5mm | 10mm | ガード | 気泡  │           │
│ │  2  |  0  |  1   |   1    |  05  │           │
│ └───────────────────────────────────────┘           │
│                                                     │
│ ※ログファイルに記録済み                                  │
└─────────────────────────────────────────────────────┘
  ↓ [キャンセル]クリック
  ↓ 初期状態へリセット
  └──→ [起動]へ戻る
```

## データフロー図

```
┌──────────────┐
│   ユーザー    │
└──────┬───────┘
       │ 1. 従業員No, カードNo入力
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 入力検証（6桁チェック）      │
│   - メッセージ表示              │
│   - ボタン制御                 │
└──────┬───────────────────────┘
       │ 2. カードNo検索
       ↓
┌──────────────────────────────┐
│  CardConditionLoader         │
│   - CSV読み込み                │
│   - 条件検索                   │
└──────┬───────────────────────┘
       │ 3. 条件取得
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 条件表示                   │
│   - 照合ボタン有効化            │
└──────┬───────────────────────┘
       │ 4. 初回計測要求
       ↓
┌──────────────────────────────┐
│     BalanceManager           │
│   - 3台の天秤を順次計測         │
│   - 初回値を保存               │
└──────┬───────────────────────┘
       │ 5. 各天秤へ計測要求
       ↓
┌──────────────────────────────┐
│   SerialPortManager × 3      │
│   - COMポートオープン          │
│   - Qコマンド送信              │
│   - 応答受信・パース            │
│   - タイムアウト・リトライ       │
└──────┬───────────────────────┘
       │ 6. 計測値返却
       ↓
┌──────────────────────────────┐
│     BalanceManager           │
│   - 初回値保存完了             │
└──────┬───────────────────────┘
       │ 7. 計測完了通知
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 「使用部材条件を表示」表示   │
└──────┬───────────────────────┘
       │ 8. [照合]クリック
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 従業員No再検証             │
└──────┬───────────────────────┘
       │ 9. 照合時計測要求
       ↓
┌──────────────────────────────┐
│     BalanceManager           │
│   - 3台の天秤を順次計測         │
│   - 照合時値を保存             │
└──────┬───────────────────────┘
       │ 10. 各天秤へ計測要求
       ↓
┌──────────────────────────────┐
│   SerialPortManager × 3      │
│   - Qコマンド送信              │
│   - 応答受信・パース            │
└──────┬───────────────────────┘
       │ 11. 計測値返却
       ↓
┌──────────────────────────────┐
│     BalanceManager           │
│   - 差分計算                   │
│   - {Pre_10mm: diff1, ...}   │
└──────┬───────────────────────┘
       │ 12. 差分値返却
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 差分と予定数を比較          │
│   - 合否判定                   │
└──────┬───────────────────────┘
       │ 13. OK時: ログ出力要求
       ↓
┌──────────────────────────────┐
│       LogManager             │
│   - logs/yyyyMMdd.csv作成     │
│   - CSV行追加                 │
└──────┬───────────────────────┘
       │ 14. ログ記録完了
       ↓
┌──────────────────────────────┐
│     MainForm (UI Layer)      │
│   - 「検査合格」表示（緑）       │
│   - 照合ボタン無効化            │
└──────────────────────────────┘
```

## シーケンス図（正常系）

```
ユーザー  MainForm  CardLoader  BalanceManager  SerialPortManager×3  LogManager
  |         |          |              |                  |               |
  |--入力-->|          |              |                  |               |
  |         |--検索--->|              |                  |               |
  |         |<-条件----|              |                  |               |
  |         |          |              |                  |               |
  |         |--------初回計測-------->|                  |               |
  |         |          |              |----Q--->         |               |
  |         |          |              |<---値---|        |               |
  |         |          |              |         |----Q-->|               |
  |         |          |              |         |<--値---|               |
  |         |          |              |                  |----Q--------->|
  |         |          |              |                  |<---値---------|
  |         |<--------完了------------|                  |               |
  |         |                                                            |
  |--照合-->|          |              |                  |               |
  |         |-------照合時計測------->|                  |               |
  |         |          |              |----Q--->         |               |
  |         |          |              |<---値---|        |               |
  |         |          |              |         |----Q-->|               |
  |         |          |              |         |<--値---|               |
  |         |          |              |                  |----Q--------->|
  |         |          |              |                  |<---値---------|
  |         |<-------差分値-----------|                  |               |
  |         |                                                            |
  |         |--判定-->|              |                  |               |
  |         |<--OK----|              |                  |               |
  |         |                                                            |
  |         |------------------------------------------ログ記録---------->|
  |         |<-----------------------------------------完了--------------|
  |         |                                                            |
  |<-合格---|          |              |                  |               |
  |         |          |              |                  |               |
```

## エラーハンドリングフロー

```
[通信エラー発生]
  ↓
┌─────────────────────────────┐
│   SerialPortManager         │
│   - タイムアウト検知          │
└─────────┬───────────────────┘
          │
          ↓ リトライ可能？
          ├─ YES → 再送信（最大N回）
          │           ↓
          │       [成功] → 正常フローへ
          │           ↓
          └─ NO  → [失敗]
                    ↓
┌─────────────────────────────┐
│   BalanceManager            │
│   - エラー情報を集約         │
└─────────┬───────────────────┘
          │
          ↓
┌─────────────────────────────┐
│   MainForm                  │
│   - エラーメッセージ表示（赤）│
│   - 照合ボタン無効化         │
└─────────┬───────────────────┘
          │
          ↓
┌─────────────────────────────┐
│   LogManager                │
│   - エラーログ記録           │
│   - logs/error/*.log        │
└─────────────────────────────┘
```

## ファイルI/O フロー

### 起動時

```
[アプリケーション起動]
  ↓
┌─────────────────────────────┐
│   ConfigLoader              │
│   - appsettings.json読み込み │
└─────────┬───────────────────┘
          │
          ↓ ファイル存在？
          ├─ YES → パース
          │           ↓
          │       [成功] → 設定保持
          │           ↓
          └─ NO  → デフォルト設定生成
                    ↓
                  ファイル作成
                    ↓
┌─────────────────────────────┐
│   CardConditionLoader       │
│   - card_conditions.csv読込  │
└─────────┬───────────────────┘
          │
          ↓ ファイル存在？
          ├─ YES → パース → メモリ保持
          │
          └─ NO  → サンプルCSV生成
                    ↓
                  ファイル作成
                    ↓
┌─────────────────────────────┐
│   BalanceManager            │
│   - COMポートオープン        │
└─────────┬───────────────────┘
          │
          ↓ 成功？
          ├─ YES → 準備完了
          │
          └─ NO  → 警告ログ記録（継続）
```

### ログ出力時

```
[検査合格]
  ↓
┌─────────────────────────────┐
│   LogManager                │
│   - ログディレクトリ確認      │
└─────────┬───────────────────┘
          │
          ↓ ディレクトリ存在？
          ├─ YES
          │
          └─ NO  → ディレクトリ作成
                    ↓
          ログファイル存在確認
          (logs/yyyyMMdd.csv)
                    ↓
          ├─ YES → 追記モード
          │           ↓
          │       データ行追加
          │
          └─ NO  → 新規作成
                    ↓
                  ヘッダー行書き込み
                    ↓
                  データ行書き込み
                    ↓
                  ファイルクローズ
```

## 状態遷移図（UIボタン）

```
┌──────────────┐
│  初期状態     │
│  照合: 無効   │
└──────┬───────┘
       │ カードNo入力完了 & 条件あり
       ↓
┌──────────────┐
│  条件表示     │
│  照合: 有効   │
└──────┬───────┘
       │ [照合]クリック & 合格
       ↓
┌──────────────┐
│  検査完了     │
│  照合: 無効   │
└──────┬───────┘
       │ [キャンセル]クリック
       ↓
       [初期状態へ戻る]

※ NGの場合は「条件表示」状態を維持（再試行可能）
```

## コンポーネント図

```
┌─────────────────────────────────────────────────────┐
│                  MainForm.vb                        │
│  ┌───────────┐  ┌────────────┐  ┌───────────────┐  │
│  │ TextBox   │  │  Button    │  │ DataGridView  │  │
│  │ 従業員No  │  │  [照合]    │  │ 条件テーブル   │  │
│  │ カードNo  │  │[キャンセル]│  │               │  │
│  └───────────┘  └────────────┘  └───────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │           Label (メッセージ)                  │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ↓               ↓               ↓
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ConfigLoader │  │CardLoader   │  │BalanceManager│
└─────────────┘  └─────────────┘  └──────┬───────┘
                                          │
                          ┌───────────────┼───────────────┐
                          ↓               ↓               ↓
                  ┌──────────────┐┌──────────────┐┌──────────────┐
                  │SerialPort#1  ││SerialPort#2  ││SerialPort#3  │
                  │(Pre_10mm)    ││(Post_1mm)    ││(Post_5mm)    │
                  └──────────────┘└──────────────┘└──────────────┘
                          ↓               ↓               ↓
                    [EK-2000i #1] [EK-2000i #2] [EK-2000i #3]
```

この図は、アプリケーションの動作フローと構造を視覚的に表現しています。
