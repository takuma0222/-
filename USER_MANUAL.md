# 操作マニュアル

## 起動手順

### 🧪 テスト環境での起動（シミュレータ使用）

#### 1. 電子天秤シミュレータを起動
```powershell
# シミュレータを起動
BalanceSimulator\BalanceSimulator\bin\Debug\net9.0-windows\BalanceSimulator.exe
```

#### 2. 検品アプリケーションを起動
```powershell
# 検品アプリを起動
BalanceInspection\bin\Debug\BalanceInspection.exe
```

**メリット**: 実際の天秤機器がなくても完全な検品フローをテスト可能

### 🔧 実運用環境での起動

1. 3台の電子天秤（EK-2000i）をRS-232Cで接続
2. `appsettings.json`でシリアル接続設定に変更
3. デスクトップまたはスタートメニューから `BalanceInspection.exe` を起動
4. アプリケーションのメイン画面が表示されます

## メイン画面の構成

```
┌────────────────────────────────────────────────────────┐
│  検品デスクトップアプリ                                      │
├────────────────────────────────────────────────────────┤
│  従業員No: [______]  カードNo: [______] [照合] [キャンセル]│
│                                                        │
│  メッセージ: 従業員Noを入力してください                        │
│                                                        │
│  ┌──────────────────────────────────────────────┐     │
│  │ 1mmクッション材 │ 5mmクッション材 │ 10mmクッション材 │...│     │
│  ├──────────────────────────────────────────────┤     │
│  │                                              │     │
│  └──────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────┘
```

### 入力項目

1. **従業員No**: 6桁の英数字を入力
   - 半角英数字のみ
   - 必須項目

2. **カードNo**: 6桁の英数字を入力
   - 半角英数字のみ
   - 必須項目
   - ✨ **自動処理**: 入力完了後、以下が自動実行されます
     - 使用部材条件がテーブルに表示
     - **初回計測が5秒タイムアウトで自動開始**
     - 3台の天秤から重量データを取得

### ボタン

1. **照合ボタン**: 
   - 使用部材条件表示後に有効化
   - クリックすると照合時計測を実行し、合否判定を行います

2. **キャンセルボタン**:
   - 入力内容をクリアし、初期画面に戻ります

### 表示項目

1. **メッセージ欄**:
   - 現在の状態やエラーメッセージを表示
   - 最大30文字
   - エラー時は赤字で表示

2. **使用部材条件テーブル**:
   - カード番号に対応する使用部材条件を表示
   - 列: 1mmクッション材、5mmクッション材、10mmクッション材、エッジガード、気泡緩衝材

## 操作手順

### 基本的な検査フロー

1. **従業員番号の入力**
   ```
   従業員No: 123456
   ```
   - 6桁の英数字を入力します
   - 入力中は「従業員Noを入力してください」と表示されます

2. **カード番号の入力**
   ```
   カードNo: e00123
   ```
   - 6桁の英数字を入力します
   - カード番号の入力欄からフォーカスが外れると、自動的に処理が開始されます

3. **使用部材条件の表示と初回計測** ✨ 自動処理
   - カード番号に対応する条件がテーブルに表示されます
   - **5秒タイムアウトで初回計測が自動実行**されます
   - TCP接続時: シミュレータまたは実天秤から重量データを取得
   - シリアル接続時: COMポート経由で重量データを取得
   - メッセージ欄に「初回計測完了」と表示されます
   - 成功すると「使用部材条件を表示しました」と表示されます
   - 「照合」ボタンが有効化されます

4. **部材の投入**
   - 表示された条件に従って、各天秤に部材を投入します
   - 投入前10mmクッション材、投入後1mmクッション材、投入後5mmクッション材

5. **照合実行**
   - 「照合」ボタンをクリックします
   - 3台の天秤から照合時計測値を取得します
   - 差分（照合時 - 初回）を計算し、予定数と比較します

6. **結果の確認**
   
   **合格の場合**:
   - メッセージ欄に「検査合格」と緑色で表示されます
   - ログファイルに記録されます
   - 「照合」ボタンが無効化されます
   - 次の検査を行う場合は「キャンセル」ボタンをクリックします

   **不合格の場合**:
   - メッセージ欄に不一致の詳細が赤字で表示されます
   - 例: `NG:10mm:2≠1,1mm:1≠2`
   - ログファイルに記録されます
   - 再度「照合」ボタンをクリックして再検査できます

7. **次の検査へ**
   - 「キャンセル」ボタンをクリックして初期画面に戻ります
   - 手順1から繰り返します

## メッセージ一覧

### 正常系メッセージ

| メッセージ | 意味 |
|----------|------|
| 従業員Noを入力してください | 初期状態 |
| 使用部材条件を表示しました | 条件表示と初回計測成功 |
| 検査合格 | 照合成功 |

### エラーメッセージ

| メッセージ | 意味 | 対処方法 |
|----------|------|---------|
| 従業員Noは6桁で入力してください | 従業員Noが6桁でない | 6桁の英数字を入力 |
| カードNoは6桁で入力してください | カードNoが6桁でない | 6桁の英数字を入力 |
| 条件なし | カード番号がCSVに存在しない | カード番号を確認するか、CSVファイルに追加 |
| 計測エラー:... | 天秤からの計測失敗 | 天秤の接続を確認、ケーブルを確認 |
| 照合エラー:... | 照合時の計測失敗 | 天秤の接続を確認 |
| NG:10mm:X≠Y | 10mmクッション材が不一致 | 投入数量を確認 |
| NG:1mm:X≠Y | 1mmクッション材が不一致 | 投入数量を確認 |
| NG:5mm:X≠Y | 5mmクッション材が不一致 | 投入数量を確認 |

## 注意事項

### 入力制限
- 従業員No、カードNoは6桁固定
- 半角英数字のみ入力可能（大文字は自動的に小文字に変換）

### 計測について
- 初回計測は条件表示時に自動実行されます
- 照合時計測は「照合」ボタンクリック時に実行されます
- 各計測は3台の天秤から順次取得します
- タイムアウトは設定ファイルで変更可能（デフォルト5秒）

### 照合について
- 照合対象は以下の3項目のみ:
  - 投入前10mmクッション材
  - 投入後1mmクッション材
  - 投入後5mmクッション材
- 差分が予定数と完全に一致する必要があります
- 1つでも不一致があれば不合格となります

### ログについて
- 検査ログは日次で自動ローテーションされます
- ファイル名: `logs/yyyyMMdd.csv`
- エラーログ: `logs/error/yyyy-MM-dd.log`

## トラブルシューティング

### よくある問題

**Q: 「計測エラー」が表示される**
A: 
- 天秤の電源が入っているか確認してください
- RS-232Cケーブルが正しく接続されているか確認してください
- デバイスマネージャーでCOMポートが認識されているか確認してください

**Q: カード番号を入力しても条件が表示されない**
A:
- カード番号が正しいか確認してください（6桁、半角英数字）
- `card_conditions.csv` にそのカード番号が登録されているか確認してください

**Q: 「照合」ボタンが押せない**
A:
- カード番号が正しく入力されているか確認してください
- 「条件なし」と表示されていないか確認してください
- 初回計測が成功しているか確認してください

**Q: 合格したのに「照合」ボタンが押せる**
A:
- 合格後は「照合」ボタンは自動的に無効化されます
- 「キャンセル」ボタンをクリックして次の検査に進んでください

**Q: アプリケーションが応答しない**
A:
- 通信タイムアウトの可能性があります
- しばらく待ってから、応答がない場合はタスクマネージャーで終了してください
- 設定ファイルの `ReadTimeoutMs` を増やすことを検討してください

## キーボードショートカット

現在、キーボードショートカットは実装されていません。
マウスでの操作、またはTabキーでフォーカス移動が可能です。

## データのバックアップ

定期的に以下のファイルをバックアップすることを推奨します：
- `card_conditions.csv` - カード条件マスタ
- `logs/` ディレクトリ - 検査ログとエラーログ

## 🆕 新機能ガイド

### TCP通信モード ✨

#### 自動設定
- 初回起動時にTCP接続設定が自動生成されます
- シミュレータとの連携が即座に可能です

#### 設定確認
`appsettings.json`で以下を確認：
```json
{
  "Balances": [
    {
      "LogicalName": "Pre_10mm",
      "ConnectionType": "TCP",
      "TcpAddress": "127.0.0.1", 
      "TcpPort": 9001
    }
  ]
}
```

### 電子天秤シミュレータ 🧪

#### 基本操作
1. **起動**: シミュレータを先に起動
2. **接続確認**: ポート9001-9003がリスニング状態になる
3. **重量シミュレート**: UIで重量値を調整可能
4. **接続監視**: リアルタイムで接続状況を表示

#### シミュレータの利点
- **実機不要**: 天秤なしで完全テスト
- **再現性**: 同じ条件でのテスト実行
- **開発効率**: 即座に動作確認可能
- **エラーテスト**: 通信エラーの模擬

### 自動初回計測 ⚡

#### 新しいフロー
1. 従業員番号入力（6桁）
2. カード番号入力（6桁）
3. **自動実行**: 使用部材条件表示 + 初回計測
4. 照合ボタンで照合時計測
5. 合否判定結果表示

#### タイムアウト設定
- 初回計測: **5秒固定**
- 通常計測: `appsettings.json`の`ReadTimeoutMs`に従う

## お問い合わせ

操作方法やエラーについて不明な点がある場合は、システム管理者に連絡してください。
その際、エラーメッセージのスクリーンショットがあるとスムーズに対応できます。
